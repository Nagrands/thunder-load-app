@use "../abstracts/variables";

// ==============================
// Sidebar Component (Improved & Updated)
// ==============================

// Параметры бокового меню
$sidebar-width: 260px;
$sidebar-width-collapsed: 80px;
$sidebar-padding-vertical: 0.5rem;
$sidebar-padding-horizontal: 0.2rem;
$drawer-max-width: 320px; // max width for drawer mode
$bp-drawer: 1024px; // breakpoint to switch to drawer
$transition-duration: 0.3s;
$transition-ease: ease;

// ==============================
// Toggle Button (для открытия сайдбара)
// ==============================
.toggle-btn {
  background-color: transparent;
  color: var(--color-highlight);
  border-radius: 50%;
  padding: 5px 10px;
  font-size: 16px;
  margin: 0 4px 0 8px;
  margin-left: 5rem;
  transition:
    background 0.2s ease,
    transform 0.2s ease;
  cursor: pointer;

  &.highlight {
    box-shadow: 0 0 10px var(--color-accent);
  }

  &:hover {
    color: var(--color-text-main);
    transform: scale(1.05);
  }
}

.sidebar {
  display: flex;
  flex-direction: column;
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  width: $sidebar-width;
  // Прозрачный сайдбар с тонкой разделительной линией
  background: transparent;
  border-right: 1px solid rgba(255, 255, 255, 0.06);
  color: var(--sidebar-color);
  transform: translateX(-100%);
  transition: transform 0.3s ease, width 0.2s ease;
  overflow-y: auto;
  overflow-x: hidden; // исключаем горизонтальные полосы прокрутки
  z-index: 999;
  justify-content: flex-start;
  align-items: stretch;
  padding-bottom: .75rem;

  // Псевдоэлементы для декоративных эффектов
  &::before,
  &::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    z-index: -1;
  }

  // Когда меню активно — выдвигаем его по оси X
  &.active {
    transform: translateX(0);
  }

  // Off‑canvas режим (мобильный/узкие экраны)
  &.is-drawer {
    width: min(82vw, $drawer-max-width);
    box-shadow: 0 20px 60px rgba(0,0,0,0.45);
    border-right: 1px solid rgba(255,255,255,0.08);
    backdrop-filter: blur(8px);
  }

  // Компактная панель действий вверху
  .sidebar-actions {
    position: sticky;
    top: calc(env(safe-area-inset-top, 0px) + 6px);
    z-index: 2;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: .5rem;
    padding: .5rem .5rem .25rem;
    margin-bottom: .25rem;
    background: linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0));
    border-bottom-left-radius: 12px;
    border-bottom-right-radius: 12px;
    backdrop-filter: blur(3px);
  }

  // macOS: учитываем область стандартных контролов окна (traffic lights)
  body.is-mac & {
    padding-top: 22px; // небольшой отступ сверху для зоны «светофоров»
    .sidebar-actions { top: calc(env(safe-area-inset-top, 0px) + 28px); }
  }
  .pin-btn,
  .close-btn {
    height: 36px;
    min-width: 36px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.08);
    color: var(--color-highlight);
    transition: background .16s ease, border-color .16s ease, transform .08s ease;
    cursor: pointer;
  }
  .pin-btn:hover,
  .close-btn:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.14); }
  .pin-btn:active,
  .close-btn:active { transform: translateY(1px); }
  .pin-btn:focus-visible,
  .close-btn:focus-visible { outline: 2px solid var(--color-accent); outline-offset: 2px; }
  .pin-btn.is-active { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color: var(--color-accent); }

  ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  // Элементы меню
  &-item {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    background: rgba(255,255,255,0.04);
    backdrop-filter: blur(4px);
    border: 1px var(--color-hover) solid;
    border-radius: 12px;
    transition: background-color .16s ease, border-color .16s ease, transform .08s ease, color .16s ease;
    margin: 8px 12px;
    padding: 10px 12px;
    gap: 10px;
    color: var(--color-highlight);
    cursor: pointer;
    user-select: none;

    &.dragging { opacity: .6; }
    &.drag-over { outline: 2px dashed rgba(255,255,255,0.25); }
  
    a {
      display: flex;
      align-items: center;
      width: 100%;
      text-decoration: none;
      color: inherit;
    }

    i {
      font-size: 18px;
      transition: color .16s ease;
    }

    label {
      padding-left: 0.125rem;
    }

    &:hover { background: var(--color-hover); color: var(--color-text-main); border-color: var(--color-hover); }
    &:focus-visible { outline: 2px solid var(--color-accent); outline-offset: 2px; }

    &.active {
      background-color: rgba(255,255,255,0.08);
      color: var(--color-accent);
      border-color: var(--color-accent);
      box-shadow:
        inset 2px 0 0 var(--color-accent),
        0 0 0 1px var(--color-accent) inset;
    }

    // Статусы и бейджи: счётчики, точки состояния
    .badge {
      margin-left: auto;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 18px;
      height: 18px;
      padding: 0 6px;
      border-radius: var(--border-radius);
      font-size: 11px;
      color: var(--color-text-main);
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.14);
    }
    .badge.dot { width: 8px; min-width: 8px; height: 8px; padding: 0; border-radius: 50%; background: var(--color-accent); border: none; box-shadow: 0 0 0 2px rgba(0,0,0,0.15); }
  }

  #open-github {
    background: none;
  }

  // Нижняя часть сайдбара
  &-footer {
    display: flex;
    flex-direction: column;
    justify-content: center;
    margin-top: auto;
    border-top: 1px var(--color-hover) solid;
  }

  // Логотип и текст
  .logo-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: .75rem;
    margin: 2.75rem 1rem 1rem;

    .logo {
      width: 36px;
      height: 36px;
      animation: pulseEffect 2s infinite;
    }

    i {
      color: var(--color-accent);
      font-size: 20px;
    }

    .logo-text {
      font-size: 1.2rem;
      color: var(--color-accent);

      &:hover {
        cursor: default;
        color: var(--color-highlight);
      }
    }
  }

  // Социальные ссылки
  .social-links {
    display: flex;
    justify-content: center;
    align-items: center;
    border-radius: var(--border-radius);
    margin: .25rem 1rem 0;

    .icon-links {
      display: flex;
      flex-direction: row; // по умолчанию — горизонтально
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--border-radius);
      padding: 6px 8px;
      overflow: hidden; // без внутренних скроллов
      max-width: 100%;
      box-sizing: border-box;

      a {
        position: relative;
        font-size: 18px;
        height: 36px;
        width: 36px;
        padding: 0;
        color: var(--color-highlight);
        transition:
          transform 0.2s ease,
          background-color 0.2s ease,
          color 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--border-radius);
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.08);

        // Микро‑анимация и подсветка иконок
        &:hover,
        &:focus-visible {
          color: var(--color-accent);
          background: rgba(255,255,255,0.08);
          border-color: rgba(255,255,255,0.14);
          transform: translateY(-1px);
        }

        // Индивидуальные стили для соц. сетей
        &[href="https://www.youtube.com"]
        {
          &:hover {
            color: var(--color-youtube);
            border-color: var(--color-youtube);
          }
        }
        &[href="https://www.twitch.tv"]
        {
          &:hover {
            color: var(--color-twitch);
            border-color: var(--color-twitch);
          }
        }
        &[href="https://vkvideo.ru"]
        {
          &:hover {
            color: var(--color-vkvideo);
            border-color: var(--color-vkvideo);
          }
        }
        &[href="https://www.coub.com"]
        {
          &:hover {
            color: var(--color-coub);
            border-color: var(--color-coub);
          }
        }
      }
    }

    // При закреплении — оставляем горизонтальную ленту (как по умолчанию)
    .sidebar.is-pinned & .icon-links {
      flex-direction: row;
      align-items: center;
      border-radius: var(--border-radius);
      padding: 6px 8px;
    }
    .sidebar.is-pinned & .icon-links a {
      width: 36px;
      justify-content: center;
      padding: 0;
      border-radius: var(--border-radius);
    }
  }

  // Навигация с подписями (вертикальный список, полноценные элементы)
  #sidebar-nav {
    display: flex;
    flex-direction: column;
    align-items: stretch;
    gap: 6px;
    margin: .5rem .75rem;
    overflow: visible;
  }
  #sidebar-nav .sidebar-item {
    position: relative;
    width: auto;
    height: auto;
    min-height: 36px;
    padding: 8px 12px;
    justify-content: flex-start;
    border-radius: 10px;
    transition: background-color .16s ease, border-color .16s ease, transform .08s ease, color .16s ease;
  }
  #sidebar-nav .sidebar-item i { font-size: 18px; }
  #sidebar-nav .sidebar-item span { display: inline; }
  #sidebar-nav .sidebar-item .badge {
    position: static;
    margin-left: auto;
    min-width: 18px; height: 18px; padding: 0 6px;
    font-size: 11px;
    border-width: 1px;
    background: rgba(255,255,255,0.10);
    color: var(--color-text-main);
  }
  // Микровзаимодействия для пунктов навигации
  #sidebar-nav .sidebar-item:hover,
  #sidebar-nav .sidebar-item:focus-visible {
    background: rgba(255,255,255,0.08);
    border-color: rgba(255,255,255,0.14);
    transform: translateY(-1px);
    color: var(--color-accent);
  }
  // Разделитель: плавность и реакции на hover/focus
  #sidebar-nav .sidebar-item:not(:first-child)::before {
    transition: background-color .16s ease, opacity .16s ease;
  }
  #sidebar-nav .sidebar-item:hover::before { background: transparent; }
  #sidebar-nav .sidebar-item:hover + .sidebar-item::before { background: transparent; }
  #sidebar-nav .sidebar-item:focus-visible::before,
  #sidebar-nav .sidebar-item:active::before { background: var(--color-accent); }
  // Тонкий разделитель между пунктами

  // В свернутом режиме — компактные строки (иконка+текст остаются, ширина ограничена)
  &.is-collapsed #sidebar-nav {
    // margin: .25rem .5rem;
    gap: 4px;
  }
  // В свернутом режиме — без разделителей, компактные элементы
  &.is-collapsed #sidebar-nav .sidebar-item { padding: 6px 10px; border-radius: 10px; }
  &.is-collapsed #sidebar-nav .sidebar-item:not(:first-child)::before { display: none; }

  .close-btn {
    border-bottom: none;
    font-size: 16px;
  }

  // Свернутый режим
  &.is-collapsed {
    width: $sidebar-width-collapsed;
    .logo-text { display: none; }
    .sidebar-item { justify-content: center; padding: 8px; margin: 6px; }
    .sidebar-item span { display: none; }
    // у навигации принудительно скрываем подписи
    #sidebar-nav .sidebar-item span { display: none; }
    .sidebar-actions { justify-content: center; align-items: center; flex-direction: column; gap: 6px; padding: 6px; }
    .social-links { justify-content: center; margin: .25rem .5rem 0; }
    // В компактном режиме заголовки групп не показываем
    .sidebar-title { display: none; }
    // И содержимое групп держим раскрытым без ограничений высоты
    .sidebar-collapse { max-height: none !important; overflow: visible; }
    // Иконки сервисов: вертикальная колонка компактных кнопок с читаемым фоном
    .social-links .icon-links {
      flex-direction: column;
      align-items: center;
      background: transparent;
      border: none;
      gap: 8px;
      padding: 0;
      overflow: visible;
    }
    .social-links .icon-links a {
      width: 36px;
      height: 36px;
      padding: 0;
      justify-content: center;
      border-radius: 10px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .social-links .icon-links a:hover,
    .social-links .icon-links a:focus-visible {
      background: rgba(255,255,255,0.10);
      border-color: rgba(255,255,255,0.16);
    }
    // Кнопка GitHub в футере — как сервисная иконка
    #open-github.sidebar-item {
      width: 36px;
      height: 36px;
      padding: 0;
      margin: 6px auto 8px; // центр по горизонтали
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      align-self: center; // центрирование в колонке футера
    }
    #open-github.sidebar-item:hover,
    #open-github.sidebar-item:focus-visible {
      background: rgba(255,255,255,0.10);
      border-color: rgba(255,255,255,0.16);
    }
    // центрируем содержимое футера
    .sidebar-footer { align-items: center; }
  }

  // Навигация и структура: группы и заголовки
  .sidebar-group { margin: .5rem .75rem; }
  .sidebar-title {
    margin: .5rem .5rem .25rem;
    padding: 0 .25rem;
    font-size: 11px;
    letter-spacing: .08em;
    text-transform: uppercase;
    color: var(--color-quality);
    opacity: .9;
    display: flex; align-items: center; gap: 6px;
    cursor: pointer;
    user-select: none;
    border-radius: 8px;
    position: relative;
    min-height: 24px;
  }
  // chevron indicator
  .sidebar-title::before {
    content: "";
    width: 0; height: 0;
    border-left: 5px solid transparent;
    border-right: 5px solid transparent;
    border-top: 6px solid var(--color-quality);
    opacity: .85;
    transform-origin: 50% 45%;
    transition: transform .16s ease, opacity .16s ease;
  }
  .sidebar-title[aria-expanded="false"]::before { transform: rotate(-90deg); opacity: .7; }
  .sidebar-title:focus-visible { outline: 2px solid var(--color-accent); outline-offset: 2px; }

  // collapsible container
  .sidebar-collapse {
    overflow: hidden;
    transition: max-height .22s ease;
    max-height: 1000px; // default expanded; JS will adjust
  }
  .sidebar-title::after { content: ""; height: 1px; flex: 1 1 auto; background: rgba(255,255,255,0.08); }
}

// Мобильная компоновка: по умолчанию как off‑canvas
@media (max-width: $bp-drawer) {
  .sidebar {
    width: min(82vw, $drawer-max-width);
  }
  .sidebar .pin-btn { display: none; } // pin не нужен на телефонах
}

// ==============================
// Close Button (для закрытия сайдбара)
// ==============================

// ==============================
// Overlay (подложка для мобильных устройств)
// ==============================
.overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(3px);
  transition: opacity 0.3s ease;
  z-index: 998;
  display: none;
  &.active {
    display: block;
  }
}

// Платформенные детали: drag region (macOS)
.drag-region { -webkit-app-region: drag; }
.no-drag, .sidebar button, .sidebar a, .sidebar .sidebar-item { -webkit-app-region: no-drag; }

@media (prefers-reduced-motion: reduce) {
  .sidebar, .sidebar * { transition: none !important; animation: none !important; }
}
